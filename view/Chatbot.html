<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chatbot Th∆∞ vi·ªán ƒê·∫°i h·ªçc</title>

  <style>
    :root {
      --bg: #f9fafb;
      --panel: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --muted: #64748b;
      --accent: #0ea5e9;
      --user-bg: #0ea5e9;
      --bot-bg: #f1f5f9;
      --online: #10b981;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
    }

    /* ====== N√öT M·ªû CHATBOT ====== */
    .chat-toggle {
      position: fixed;
      bottom: 24px; right: 24px;
      width: 64px; height: 64px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      display: grid;
      place-items: center;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(14,165,233,.35);
      z-index: 10000;
      transition: all .25s ease;
    }
    .chat-toggle:hover { transform: scale(1.12); }

    /* ====== WIDGET CHAT ====== */
    .chat-widget {
      position: fixed;
      bottom: 96px; right: 24px;
      width: 400px;
      max-width: calc(100vw - 48px);
      height: 650px;
      background: var(--panel);
      border-radius: 22px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.18);
      overflow: hidden;
      display: none;
      flex-direction: column;
      z-index: 9999;
      border: 1px solid var(--border);
      animation: fadeInWidget 0.35s ease;
    }
    .chat-widget.open { display: flex; }

    @keyframes fadeInWidget {
      from { opacity: 0; transform: translateY(20px); }
    }

    /* ===== HEADER ===== */
    .chat-header {
      padding: 20px;
      background: linear-gradient(135deg, var(--accent), #0c8bd4);
      color: white;
    }
    .chat-header h1 { font-size: 18px; font-weight: 600; }
    .chat-header .sub { font-size: 13px; opacity: 0.95; margin-top: 4px; }
    .status-dot {
      width: 10px; height: 10px;
      background: var(--online);
      border-radius: 50%;
      display: inline-block;
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 
      0%,100% { opacity:1; }
      50% { opacity:.5; }
    }

    /* ===== BODY CHAT ===== */
    .chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: var(--bg);
    }
    .chat-body::-webkit-scrollbar { width: 5px; }
    .chat-body::-webkit-scrollbar-thumb {
      background: #cbd5e1; border-radius: 10px;
    }

    .message {
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      animation: messageIn 0.3s ease;
    }
    @keyframes messageIn {
      from { opacity:0; transform: translateY(10px); }
    }

    .message.bot { align-self: flex-start; }
    .message.user { flex-direction: row-reverse; }

    .bubble {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .message.bot .bubble {
      background: var(--bot-bg);
      border-bottom-left-radius: 4px;
      border: 1px solid var(--border);
    }
    .message.user .bubble {
      background: var(--user-bg);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .bubble img {
      max-width: 100%;
      border-radius: 12px;
      margin-top: 8px;
    }

    /* ===== TYPING ===== */
    .typing { display: flex; gap: 6px; padding: 12px 16px; }
    .typing span {
      width: 8px; height: 8px;
      background: var(--muted);
      border-radius: 50%;
      animation: bounce 1.3s infinite;
    }
    .typing span:nth-child(2) { animation-delay: .15s; }
    .typing span:nth-child(3) { animation-delay: .3s; }

    @keyframes bounce {
      0%,100% { transform:translateY(0); }
      50% { transform:translateY(-10px); }
    }

    /* ===== INPUT ===== */
    .chat-input {
      padding: 16px;
      background: var(--panel);
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .input-tools { display: flex; gap: 10px; align-items: center; }

    textarea {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 15px;
      resize: none;
      max-height: 120px;
      outline: none;
    }
    textarea:focus { border-color: var(--accent); }

    .tool-btn {
      width: 42px; height: 42px;
      border: none; background: transparent;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      border-radius: 50%;
      display: grid; place-items: center;
      transition: .2s;
    }
    .tool-btn:hover { background: #f1f5f9; color: var(--accent); }
    .tool-btn.active { color: var(--accent); background: #e0f2fe; }

    .send-btn {
      background: var(--accent);
      color: white;
    }
    .send-btn:hover { background: #0d94d2; }

    /* ===== QUICK REPLY ===== */
    .quick-replies {
      display: flex; flex-wrap: wrap;
      gap: 8px; margin-top: 12px;
    }
    .quick-chip {
      padding: 10px 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 32px;
      font-size: 14px;
      cursor: pointer;
      transition: all .2s;
    }
    .quick-chip:hover {
      background: #e0f2fe;
      border-color: var(--accent);
      color: var(--accent);
    }

    /* PREVIEW */
    .preview { padding: 8px 0; font-size:13px; color: var(--accent); }
    .preview img, .preview video { max-width: 100%; border-radius: 8px; margin-top: 8px; }

  </style>
</head>
<body>

  <!-- N√öT M·ªû CHATBOT -->
  <div class="chat-toggle" id="toggleBtn">
    üí¨
  </div>

  <!-- WIDGET CHAT -->
  <div class="chat-widget" id="chatWidget">
    <div class="chat-header">
      <h1>Th∆∞ vi·ªán ƒê·∫°i h·ªçc</h1>
      <div class="sub"><span class="status-dot"></span> ƒêang tr·ª±c tuy·∫øn ‚Ä¢ S·∫µn s√†ng h·ªó tr·ª£</div>
    </div>

    <div class="chat-body" id="chatBody">
      <div style="text-align:center; padding:60px 20px; color:var(--muted);">
        <p style="font-size:20px; margin-bottom:8px;">Xin ch√†o! üëã</p>
        <p>M√¨nh c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay?</p>

        <div class="quick-replies">
          <div class="quick-chip" data-text="Gi·ªù m·ªü c·ª≠a th∆∞ vi·ªán?">Gi·ªù m·ªü c·ª≠a</div>
          <div class="quick-chip" data-text="Quy ƒë·ªãnh m∆∞·ª£n s√°ch?">M∆∞·ª£n s√°ch</div>
          <div class="quick-chip" data-text="C√°ch t√¨m gi√°o tr√¨nh?">T√¨m gi√°o tr√¨nh</div>
        </div>
      </div>
    </div>

    <!-- INPUT -->
    <div class="chat-input">
      <div class="preview" id="preview"></div>

      <div class="input-tools">
        <button class="tool-btn" id="attachBtn">üìé</button>
        <button class="tool-btn" id="cameraBtn">üì∑</button>
        <button class="tool-btn" id="micBtn">üé§</button>

        <input type="file" id="fileInput" accept="image/*" hidden>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden>

        <textarea id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." rows="1"></textarea>
        <button class="tool-btn send-btn" id="sendBtn">‚û§</button>
      </div>
    </div>
  </div>

  <!-- ====== JAVASCRIPT ====== -->
  <script>
    const CHAT_API_URL = "/chat";

    const toggleBtn = document.getElementById("toggleBtn");
    const widget = document.getElementById("chatWidget");
    const chatBody = document.getElementById("chatBody");
    const input = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const fileInput = document.getElementById("fileInput");
    const cameraInput = document.getElementById("cameraInput");
    const attachBtn = document.getElementById("attachBtn");
    const cameraBtn = document.getElementById("cameraBtn");
    const micBtn = document.getElementById("micBtn");
    const preview = document.getElementById("preview");

    let mediaRecorder;
    let audioChunks = [];

    toggleBtn.onclick = () => widget.classList.toggle("open");

    // QUICK REPLY
    document.querySelectorAll(".quick-chip").forEach(chip => {
      chip.onclick = () => {
        input.value = chip.dataset.text;
        input.focus();
      };
    });

    /* ==== G·ª¨I ·∫¢NH ==== */
    attachBtn.onclick = () => fileInput.click();
    fileInput.onchange = e => handleFile(e.target.files[0]);

    /* ==== CAMERA ==== */
    cameraBtn.onclick = () => cameraInput.click();
    cameraInput.onchange = e => handleFile(e.target.files[0]);

    function handleFile(file) {
      if (!file) return;
      const url = URL.createObjectURL(file);

      preview.innerHTML = `
        <div>ƒê√£ ch·ªçn: <strong>${file.name}</strong></div>
        <img src="${url}">
        <div style="margin-top:6px; cursor:pointer;" onclick="clearPreview()">H·ªßy</div>
      `;
      preview.file = file;
    }
    window.clearPreview = () => {
      preview.innerHTML = "";
      preview.file = null;
      preview.audioBlob = null;
      fileInput.value = cameraInput.value = "";
    };

    /* ==== GHI √ÇM ==== */
    micBtn.onclick = async () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        micBtn.classList.remove("active");
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          const url = URL.createObjectURL(audioBlob);

          preview.innerHTML = `
            <div>ƒê√£ ghi √¢m</div>
            <audio controls src="${url}"></audio>
            <div style="margin-top:6px; cursor:pointer;" onclick="clearPreview()">H·ªßy</div>
          `;
          preview.audioBlob = audioBlob;

          stream.getTracks().forEach(t => t.stop());
        };

        mediaRecorder.start();
        micBtn.classList.add("active");
      } catch (err) {
        alert("Kh√¥ng th·ªÉ truy c·∫≠p microphone: " + err.message);
      }
    };

    /* ==== G·ª¨I TIN NH·∫ÆN ==== */
    async function sendMessage() {
      let text = input.value.trim();
      const imageFile = preview.file;
      const audioBlob = preview.audioBlob;

      if (!text && !imageFile && !audioBlob) return;

      addMessage("user",
        text || (imageFile ? "üì∑ ƒê√£ g·ª≠i ·∫£nh" : "üé§ ƒê√£ g·ª≠i ghi √¢m"),
        imageFile ? URL.createObjectURL(imageFile) : null
      );

      input.value = "";
      clearPreview();

      // typing
      const typing = document.createElement("div");
      typing.className = "message bot";
      typing.innerHTML = `<div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>`;
      chatBody.appendChild(typing);
      chatBody.scrollTop = chatBody.scrollHeight;

      // g·ª≠i API
      const form = new FormData();
      form.append("message", text);
      if (imageFile) form.append("image", imageFile);
      if (audioBlob) form.append("audio", audioBlob, "voice.webm");

      try {
        const res = await fetch(CHAT_API_URL, { method: "POST", body: form });
        const data = await res.json();
        typing.remove();
        addMessage("bot", data.answer || "Xin l·ªói, m√¨nh ch∆∞a hi·ªÉu.");
      } catch (err) {
        typing.remove();
        addMessage("bot", "Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß.");
      }
    }

    function addMessage(sender, text, imageUrl = null) {
      const div = document.createElement("div");
      div.className = `message ${sender}`;
      let html = `<div class="bubble">${text.replace(/\n/g, "<br>")}`;
      if (imageUrl) html += `<img src="${imageUrl}">`;
      html += `</div>`;
      div.innerHTML = html;

      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    sendBtn.onclick = sendMessage;
    input.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>

</body>
</html>
