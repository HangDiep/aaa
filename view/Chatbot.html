<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Library Chatbox</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121a2c; --muted:#8aa1b1; --line:#253145;
      --bot:#1e293b; --user:#155e75; --accent:#22d3ee; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020 0%,#0f172a 100%);color:#e5eff7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .app{max-width:880px;margin:auto;display:flex;flex-direction:column;height:100%}
    header{display:flex;gap:12px;align-items:center;padding:16px 20px;border-bottom:1px solid var(--line)}
    header .dot{width:10px;height:10px;border-radius:999px;background:var(--accent);box-shadow:0 0 16px var(--accent)}
    header h1{font-size:18px;margin:0}
    header .sub{font-size:12px;color:var(--muted)}
    .toolbar{margin-left:auto;display:flex;gap:8px}
    .btn{padding:8px 12px;border:1px solid var(--line);background:#0f172a;color:#e5eff7;border-radius:12px;cursor:pointer}
    .btn:hover{background:#0b1226}
    .btn-danger{border-color:#3b1f26;background:#1a0f13;color:#ffb4b4}
    .btn-danger:hover{background:#2a151b}
    .chat{flex:1;overflow:auto;padding:16px 20px;scroll-behavior:smooth}
    .empty{opacity:.7;text-align:center;padding:24px;border:1px dashed var(--line);border-radius:16px}
    .msg{display:flex;gap:10px;margin:14px 0}
    .msg .avatar{width:34px;height:34px;border-radius:999px;flex:none;display:grid;place-items:center}
    .msg.user .avatar{background:linear-gradient(135deg,#0ea5e9,#22d3ee)}
    .msg.bot .avatar{background:linear-gradient(135deg,#10b981,#22d3ee)}
    .bubble{max-width:72%;padding:12px 14px;border-radius:16px;line-height:1.45;border:1px solid var(--line)}
    .msg.user .bubble{margin-left:auto;background:rgba(21,94,117,.25)}
    .msg.bot .bubble{background:rgba(30,41,59,.6)}
    .meta{font-size:11px;color:#9fb1c5;margin-top:6px}
    .composer{border-top:1px solid var(--line);padding:14px 16px;background:rgba(2,6,23,.6);backdrop-filter: blur(6px);display:flex;gap:10px;align-items:end}
    textarea{flex:1;min-height:46px;max-height:160px;resize:vertical;padding:12px 14px;border-radius:14px;border:1px solid var(--line);background:#0f172a;color:#e5eff7}
    .send{padding:10px 14px;border-radius:12px;background:var(--accent);border:0;color:#00222a;font-weight:600;cursor:pointer}
    .quick{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .quick .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:#bcd;cursor:pointer;user-select:none}
    .chip:hover{background:#0b1226}
    .footer{padding:10px 16px;color:#8aa1b1;font-size:12px}
    .kbd{padding:1px 6px;border:1px solid var(--line);border-bottom-width:2px;border-radius:6px;background:#0b1226;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .status{display:flex;gap:6px;align-items:center}
    .status .blink{width:6px;height:6px;border-radius:999px;background:var(--accent);box-shadow:0 0 10px var(--accent);animation:blink 1.2s ease-in-out infinite}
    @keyframes blink{0%,100%{opacity:.25}50%{opacity:1}}
  </style>
</head>
<body>
  <!--
    Frontend chatbox designed to integrate with your Python chatbot loop.
    Integration notes:
    - Set CHAT_API_URL below to a backend endpoint that accepts {message:"..."}
      and responds with {reply:"..."} (you can wrap your Python loop with FastAPI or Flask).
    - Quick actions include words found in your CANCEL_WORDS set (h·ªßy/tho√°t...) to end flows.
    - Export button downloads the transcript shaped roughly like your conversations table
      (user_message, bot_reply, time) so you can import to SQLite if needed.
  -->
  <div class="app">
    <header>
      <div class="dot" aria-hidden="true"></div>
      <div>
        <h1>Library Chatbox</h1>
        <div class="sub">VI Assistant ¬∑ flow-aware ¬∑ SQLite friendly</div>
      </div>
      <div class="toolbar">
        <button id="btnExport" class="btn" title="Xu·∫•t l·ªãch s·ª≠ d∆∞·ªõi d·∫°ng JSON">Xu·∫•t l·ªãch s·ª≠</button>
        <button id="btnClear" class="btn btn-danger" title="X√≥a phi√™n hi·ªán t·∫°i">X√≥a phi√™n</button>
      </div>
    </header>

    <main id="chat" class="chat" aria-live="polite" aria-label="Khu v·ª±c h·ªôi tho·∫°i">
      <div id="emptyState" class="empty">
        <p>Ch√†o b·∫°n! H√£y b·∫Øt ƒë·∫ßu trao ƒë·ªïi b·∫±ng c√°ch nh·∫≠p n·ªôi dung b√™n d∆∞·ªõi.<br/>
        M·∫πo: Nh·∫•n <span class="kbd">Enter</span> ƒë·ªÉ g·ª≠i ¬∑ <span class="kbd">Shift</span>+<span class="kbd">Enter</span> ƒë·ªÉ xu·ªëng d√≤ng.</p>
      </div>
    </main>

    <section class="composer">
      <div style="flex:1">
        <textarea id="input" placeholder="G√µ c√¢u h·ªèi‚Ä¶ (v√≠ d·ª•: Th∆∞ vi·ªán m·ªü c·ª≠a khi n√†o?)" spellcheck="true"></textarea>
        <div class="quick" aria-label="H√†nh ƒë·ªông nhanh">
          <span class="chip" data-fill="h·ªßy">H·ªßy lu·ªìng</span>
          <span class="chip" data-fill="tho√°t">Tho√°t</span>
          <span class="chip" data-fill="ƒë·ªïi ch·ªß ƒë·ªÅ">ƒê·ªïi ch·ªß ƒë·ªÅ</span>
          <span class="chip" data-fill="gi·ªù m·ªü c·ª≠a">Gi·ªù m·ªü c·ª≠a</span>
        </div>
      </div>
      <button id="send" class="send">G·ª≠i</button>
    </section>

    <div class="footer">
      <div class="status"><span class="blink" aria-hidden="true"></span> S·∫µn s√†ng ‚Äî API: <span id="apiStatus">offline</span></div>
    </div>
  </div>

  <script>
    // =============================
    // Config
    // =============================
    const CHAT_API_URL = localStorage.getItem("CHAT_API_URL") || "/chat";  // c√πng origin ‚Üí kh√¥ng CORS, kh√¥ng l·ªá thu·ªôc IP/port

    const apiStatusEl = document.getElementById('apiStatus');
    apiStatusEl.textContent = CHAT_API_URL ? CHAT_API_URL : 'offline';

    // =============================
    // State
    // =============================
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const emptyState = document.getElementById('emptyState');
    const btnExport = document.getElementById('btnExport');
    const btnClear = document.getElementById('btnClear');

    const transcript = JSON.parse(localStorage.getItem('chat_transcript')||'[]');
    let sending = false;

    // =============================
    // UI helpers
    // =============================
    function formatTime(d=new Date()){return d.toLocaleString('vi-VN',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit',year:'numeric'})}

    function msgTemplate(role, text, time){
      return `
        <article class="msg ${role}">
          <div class="avatar" aria-hidden="true">${role==='bot'?'ü§ñ':'üßë'}</div>
          <div>
            <div class="bubble">${escapeHtml(text).replace(/\n/g,'<br/>')}</div>
            <div class="meta">${role==='bot'?'Bot':'B·∫°n'} ¬∑ ${time||formatTime()}</div>
          </div>
        </article>`
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g,(c)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }

    function render(){
      chat.innerHTML = '';
      if(!transcript.length){ chat.appendChild(emptyState); }
      else {
        transcript.forEach(row => {
          chat.insertAdjacentHTML('beforeend', msgTemplate('user', row.user_message, row.time));
          chat.insertAdjacentHTML('beforeend', msgTemplate('bot', row.bot_reply, row.time));
        });
      }
      chat.scrollTop = chat.scrollHeight;
    }

    function persist(){
      localStorage.setItem('chat_transcript', JSON.stringify(transcript));
    }

    // =============================
    // Send logic
    // =============================
    async function send(){
      if(sending) return;
      const text = input.value.trim();
      if(!text) return;
      sending = true; input.value = '';

      const now = new Date();
      const record = { user_message: text, bot_reply: '‚Ä¶', time: formatTime(now) };
      transcript.push(record); persist(); render();

      let reply = '';
      try{
         if(CHAT_API_URL){
          // G·ª¨I D·∫†NG FORM (kh·ªõp FastAPI Form(...))
          const fd = new FormData();
          fd.append('message', text);

          const res = await fetch(CHAT_API_URL || "/chat", {
            method: 'POST',
            body: fd
          });
          if(!res.ok) throw new Error('HTTP '+res.status);
          reply = (await res.text()).toString();
        } else {
          // Offline mock: gives a gentle hint but keeps you productive
          reply = offlineMock(text);
        }
      }catch(err){
        reply = `Kh√¥ng g·ªçi ƒë∆∞·ª£c API (${err.message}). M·∫πo: thi·∫øt l·∫≠p CHAT_API_URL trong localStorage, v√≠ d·ª•: localStorage.setItem('CHAT_API_URL', 'http://localhost:8000/chat')`;
      }

      record.bot_reply = reply || 'Xin l·ªói, m√¨nh ch∆∞a hi·ªÉu √Ω b·∫°n.';
      persist(); render();
      sending = false;
    }

    function offlineMock(q){
      const cancelWords = ['h·ªßy','hu·ª∑','huy','cancel','tho√°t','d·ª´ng','ƒë·ªïi ch·ªß ƒë·ªÅ','doi chu de'];
      if(cancelWords.includes(q.toLowerCase())){
        return 'ƒê√£ h·ªßy lu·ªìng hi·ªán t·∫°i. B·∫°n mu·ªën h·ªèi g√¨ ti·∫øp?';
      }
      // Simple canned replies for common library questions
      if(/m·ªü c·ª≠a|gi·ªù m·ªü/.test(q.toLowerCase())) return 'Th∆∞ vi·ªán m·ªü c·ª≠a 7:30‚Äì17:00, Th·ª© 2‚ÄìTh·ª© 6.';
      if(/m∆∞·ª£n.*s√°ch|muon sach/.test(q.toLowerCase())) return 'B·∫°n c·∫ßn th·∫ª sinh vi√™n ƒë·ªÉ m∆∞·ª£n s√°ch. ƒê·∫øn qu·∫ßy th·ªß th∆∞ ƒë·ªÉ h·ªó tr·ª£ nh√©!';
      return 'Ch·∫ø ƒë·ªô offline: m√¨nh ch∆∞a hi·ªÉu, h√£y k·∫øt n·ªëi API ƒë·ªÉ c√≥ c√¢u tr·∫£ l·ªùi ch√≠nh x√°c.';
    }

    // =============================
    // Events
    // =============================
    sendBtn.addEventListener('click', send);
    input.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    })
    document.querySelectorAll('.chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{ input.value = ch.dataset.fill; input.focus(); });
    });

    btnExport.addEventListener('click', ()=>{
      // shape roughly follows your SQLite conversations schema
      const payload = transcript.map(r=>({
        user_message: r.user_message,
        bot_reply: r.bot_reply,
        intent_tag: null,
        confidence: null,
        time: r.time
      }));
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'),{href:url,download:`chat_transcript_${Date.now()}.json`});
      a.click(); URL.revokeObjectURL(url);
    });

    btnClear.addEventListener('click', ()=>{
      if(confirm('X√≥a to√†n b·ªô phi√™n chat hi·ªán t·∫°i?')){
        transcript.splice(0, transcript.length); persist(); render();
      }
    });

    // Initial render
    render();
  </script>
</body>
</html>
